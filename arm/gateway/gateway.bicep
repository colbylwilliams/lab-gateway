param resourcePrefix string = 'rdg${uniqueString(resourceGroup().id)}'

param subnet string
param apiHost string
param gatewayHost string

param keyVaultName string

param sslCertificateSecretUri string

param publicIPAddress string = ''
param privateIPAddress string

param logAnalyticsWrokspaceId string = ''

param tags object = {}

var publicIPAddressName = empty(publicIPAddress) ? '${resourcePrefix}-gw-pip' : last(split(publicIPAddress, '/'))

var appGatewayName = '${resourcePrefix}-gw'
var appGatewayFirewallPolicyName = '${resourcePrefix}-gw-waf'

var gateway = {
  frontendIp: {
    public: {
      name: 'publicFrontendIp'
      ref: {
        id: resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations/', appGatewayName, 'publicFrontendIp')
      }
    }
    private: {
      name: 'privateFrontendIp'
      ref: {
        id: resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations/', appGatewayName, 'privateFrontendIp')
      }
    }
  }
  httpListener: {
    public: {
      name: 'publicHttpListener'
      ref: {
        id: resourceId('Microsoft.Network/applicationGateways/httpListeners/', appGatewayName, 'publicHttpListener')
      }
    }
    private: {
      name: 'privateHttpListener'
      ref: {
        id: resourceId('Microsoft.Network/applicationGateways/httpListeners/', appGatewayName, 'privateHttpListener')
      }
    }
  }
  routingRule: {
    public: {
      name: 'publicRoutingRule'
      urlPathMapRef: {
        id: resourceId('Microsoft.Network/applicationGateways/urlPathMaps/', appGatewayName, 'publicRoutingRule')
      }
    }
    private: {
      name: 'privateRoutingRule'
      urlPathMapRef: {
        id: resourceId('Microsoft.Network/applicationGateways/urlPathMaps/', appGatewayName, 'privateRoutingRule')
      }
    }
  }
  backendAddressPool: {
    name: 'gatewayBackend'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/backendAddressPools/', appGatewayName, 'gatewayBackend')
    }
  }
  backendHttpSettings: {
    name: 'gatewayHttpSettings'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection/', appGatewayName, 'gatewayHttpSettings')
    }
  }
  healthCheckProbe: {
    name: 'gatewayHealthCheck'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/probes', appGatewayName, 'gatewayHealthCheck')
    }
  }
}

var api = {
  backendAddressPool: {
    name: 'apiBackend'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/backendAddressPools/', appGatewayName, 'apiBackend')
    }
  }
  backendHttpSettings: {
    name: 'apiHttpSettings'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection/', appGatewayName, 'apiHttpSettings')
    }
  }
  healthCheckProbe: {
    name: 'apiHealthCheck'
    ref: {
      id: resourceId('Microsoft.Network/applicationGateways/probes', appGatewayName, 'apiHealthCheck')
    }
  }
}

var dtlRpIpMatchCondition_centralus = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // Central US
  matchValues: [
    '13.67.128.0/20'
    '13.67.144.0/21'
    '13.67.152.0/24'
    '13.67.153.0/28'
    '13.67.153.32/27'
    '13.67.153.64/26'
    '13.67.153.128/25'
    '13.67.155.0/24'
    '13.67.156.0/22'
    '13.67.160.0/19'
    '13.67.192.0/18'
    '13.86.0.0/17'
    '13.89.0.0/16'
    '13.104.147.128/25'
    '13.104.219.128/25'
    '13.105.17.192/26'
    '13.105.24.0/24'
    '13.105.37.0/26'
    '13.105.53.192/26'
    '20.37.128.0/18'
    '20.38.96.0/23'
    '20.38.122.0/23'
    '20.40.192.0/18'
    '20.44.8.0/21'
    '20.46.224.0/19'
    '20.47.58.0/23'
    '20.47.78.0/23'
    '20.60.18.0/24'
    '20.60.30.0/23'
    '20.60.178.0/23'
    '20.80.64.0/18'
    '20.83.0.0/18'
    '20.84.128.0/17'
    '20.135.0.0/22'
    '20.135.188.0/22'
    '20.135.192.0/23'
    '20.150.43.128/25'
    '20.150.58.0/24'
    '20.150.63.0/24'
    '20.150.77.0/24'
    '20.150.89.0/24'
    '20.150.95.0/24'
    '20.157.34.0/23'
    '20.184.64.0/18'
    '20.186.192.0/18'
    '20.190.134.0/24'
    '20.190.155.0/24'
    '23.99.128.0/17'
    '23.100.80.0/21'
    '23.100.240.0/20'
    '23.101.112.0/20'
    '23.102.202.0/24'
    '40.67.160.0/19'
    '40.69.128.0/18'
    '40.77.0.0/17'
    '40.77.130.128/26'
    '40.77.137.0/25'
    '40.77.138.0/25'
    '40.77.161.64/26'
    '40.77.166.192/26'
    '40.77.171.0/24'
    '40.77.175.192/27'
    '40.77.175.240/28'
    '40.77.182.16/28'
    '40.77.182.192/26'
    '40.77.184.128/25'
    '40.77.197.0/24'
    '40.77.255.128/26'
    '40.78.128.0/18'
    '40.78.221.0/24'
    '40.82.16.0/22'
    '40.82.96.0/22'
    '40.83.0.0/20'
    '40.83.16.0/21'
    '40.83.24.0/26'
    '40.83.24.64/27'
    '40.83.24.128/25'
    '40.83.25.0/24'
    '40.83.26.0/23'
    '40.83.28.0/22'
    '40.83.32.0/19'
    '40.86.0.0/17'
    '40.87.180.0/30'
    '40.87.180.4/31'
    '40.87.180.14/31'
    '40.87.180.16/30'
    '40.87.180.20/31'
    '40.87.180.28/30'
    '40.87.180.32/29'
    '40.87.180.42/31'
    '40.87.180.44/30'
    '40.87.180.48/28'
    '40.87.180.64/30'
    '40.87.180.74/31'
    '40.87.180.76/30'
    '40.87.182.4/30'
    '40.87.182.8/29'
    '40.87.182.24/29'
    '40.87.182.32/28'
    '40.87.182.48/29'
    '40.87.182.56/30'
    '40.87.182.62/31'
    '40.87.182.64/26'
    '40.87.182.128/25'
    '40.87.183.0/28'
    '40.87.183.16/29'
    '40.87.183.24/30'
    '40.87.183.34/31'
    '40.87.183.36/30'
    '40.87.183.42/31'
    '40.87.183.44/30'
    '40.87.183.54/31'
    '40.87.183.56/29'
    '40.87.183.64/26'
    '40.87.183.144/28'
    '40.87.183.160/27'
    '40.87.183.192/27'
    '40.87.183.224/29'
    '40.87.183.232/30'
    '40.87.183.236/31'
    '40.87.183.244/30'
    '40.87.183.248/29'
    '40.89.224.0/19'
    '40.90.16.0/27'
    '40.90.21.128/25'
    '40.90.22.0/25'
    '40.90.26.128/25'
    '40.90.129.224/27'
    '40.90.130.64/28'
    '40.90.130.192/28'
    '40.90.132.192/26'
    '40.90.137.224/27'
    '40.90.140.96/27'
    '40.90.140.224/27'
    '40.90.141.0/27'
    '40.90.142.128/27'
    '40.90.142.240/28'
    '40.90.144.0/27'
    '40.90.144.128/26'
    '40.90.148.176/28'
    '40.90.149.96/27'
    '40.90.151.144/28'
    '40.90.154.64/26'
    '40.90.156.192/26'
    '40.90.158.64/26'
    '40.93.8.0/24'
    '40.113.192.0/18'
    '40.122.16.0/20'
    '40.122.32.0/19'
    '40.122.64.0/18'
    '40.122.128.0/17'
    '40.126.6.0/24'
    '40.126.27.0/24'
    '52.101.8.0/24'
    '52.101.32.0/22'
    '52.102.130.0/24'
    '52.103.4.0/24'
    '52.103.130.0/24'
    '52.108.165.0/24'
    '52.108.166.0/23'
    '52.108.185.0/24'
    '52.108.208.0/21'
    '52.109.8.0/22'
    '52.111.227.0/24'
    '52.112.113.0/24'
    '52.113.129.0/24'
    '52.114.128.0/22'
    '52.115.76.0/22'
    '52.115.80.0/22'
    '52.115.88.0/22'
    '52.125.128.0/22'
    '52.136.30.0/24'
    '52.141.192.0/19'
    '52.141.240.0/20'
    '52.143.193.0/24'
    '52.143.224.0/19'
    '52.154.0.0/18'
    '52.154.128.0/17'
    '52.158.160.0/20'
    '52.158.192.0/19'
    '52.165.0.0/19'
    '52.165.32.0/20'
    '52.165.48.0/28'
    '52.165.49.0/24'
    '52.165.56.0/21'
    '52.165.64.0/19'
    '52.165.96.0/21'
    '52.165.104.0/25'
    '52.165.128.0/17'
    '52.173.0.0/16'
    '52.176.0.0/17'
    '52.176.128.0/19'
    '52.176.160.0/21'
    '52.176.176.0/20'
    '52.176.192.0/19'
    '52.176.224.0/24'
    '52.180.128.0/19'
    '52.180.184.0/27'
    '52.180.184.32/28'
    '52.180.185.0/24'
    '52.182.128.0/17'
    '52.185.0.0/19'
    '52.185.32.0/20'
    '52.185.48.0/21'
    '52.185.56.0/26'
    '52.185.56.64/27'
    '52.185.56.96/28'
    '52.185.56.128/27'
    '52.185.56.160/28'
    '52.185.64.0/19'
    '52.185.96.0/20'
    '52.185.112.0/26'
    '52.185.112.96/27'
    '52.185.120.0/21'
    '52.189.0.0/17'
    '52.228.128.0/17'
    '52.230.128.0/17'
    '52.232.157.0/24'
    '52.238.192.0/18'
    '52.239.150.0/23'
    '52.239.177.32/27'
    '52.239.177.64/26'
    '52.239.177.128/25'
    '52.239.195.0/24'
    '52.239.234.0/23'
    '52.242.128.0/17'
    '52.245.68.0/24'
    '52.245.69.32/27'
    '52.245.69.64/27'
    '52.245.69.96/28'
    '52.245.69.144/28'
    '52.245.69.160/27'
    '52.245.69.192/26'
    '52.245.70.0/23'
    '52.255.0.0/19'
    '65.55.144.0/23'
    '65.55.146.0/24'
    '104.43.128.0/17'
    '104.44.88.160/27'
    '104.44.91.160/27'
    '104.44.92.224/27'
    '104.44.94.80/28'
    '104.208.0.0/19'
    '104.208.32.0/20'
    '131.253.36.224/27'
    '157.55.108.0/23'
    '168.61.128.0/25'
    '168.61.128.128/28'
    '168.61.128.160/27'
    '168.61.128.192/26'
    '168.61.129.0/25'
    '168.61.129.128/26'
    '168.61.129.208/28'
    '168.61.129.224/27'
    '168.61.130.64/26'
    '168.61.130.128/25'
    '168.61.131.0/26'
    '168.61.131.128/25'
    '168.61.132.0/26'
    '168.61.144.0/20'
    '168.61.160.0/19'
    '168.61.208.0/20'
    '193.149.72.0/21'
    '2603:1030::/45'
    '2603:1030:9:2::/63'
    '2603:1030:9:4::/62'
    '2603:1030:9:8::/61'
    '2603:1030:9:10::/62'
    '2603:1030:9:14::/63'
    '2603:1030:9:17::/64'
    '2603:1030:9:18::/61'
    '2603:1030:9:20::/59'
    '2603:1030:9:40::/58'
    '2603:1030:9:80::/59'
    '2603:1030:9:a0::/60'
    '2603:1030:9:b3::/64'
    '2603:1030:9:b4::/63'
    '2603:1030:9:b7::/64'
    '2603:1030:9:b8::/63'
    '2603:1030:9:bd::/64'
    '2603:1030:9:be::/63'
    '2603:1030:9:c0::/58'
    '2603:1030:9:100::/64'
    '2603:1030:9:104::/62'
    '2603:1030:9:108::/62'
    '2603:1030:9:10c::/64'
    '2603:1030:9:111::/64'
    '2603:1030:9:112::/63'
    '2603:1030:9:114::/64'
    '2603:1030:9:118::/62'
    '2603:1030:9:11c::/63'
    '2603:1030:9:11f::/64'
    '2603:1030:9:120::/61'
    '2603:1030:9:128::/62'
    '2603:1030:9:12f::/64'
    '2603:1030:9:130::/63'
    '2603:1030:a::/47'
    '2603:1030:d::/48'
    '2603:1030:10::/48'
    '2603:1036:2403::/48'
    '2603:1036:2500:1c::/64'
    '2603:1036:3000:100::/59'
    '2603:1037:1:100::/59'
    '2a01:111:f403:c904::/62'
    '2a01:111:f403:d104::/62'
    '2a01:111:f403:d904::/62'
    '2a01:111:f403:e004::/62'
    '2a01:111:f403:f904::/62'
  ]
}

var dtlRpIpMatchCondition_eastus = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // East US
  matchValues: [
    '13.68.128.0/17'
    '13.72.64.0/18'
    '13.82.0.0/16'
    '13.90.0.0/16'
    '13.92.0.0/16'
    '13.104.144.128/27'
    '13.104.152.128/25'
    '13.104.192.0/21'
    '13.104.211.0/25'
    '13.104.214.128/25'
    '13.104.215.0/25'
    '13.105.17.0/26'
    '13.105.19.0/25'
    '13.105.20.192/26'
    '13.105.27.0/25'
    '13.105.27.192/27'
    '13.105.36.192/26'
    '13.105.74.48/28'
    '20.38.98.0/24'
    '20.39.32.0/19'
    '20.42.0.0/17'
    '20.47.1.0/24'
    '20.47.16.0/23'
    '20.47.31.0/24'
    '20.47.108.0/23'
    '20.47.113.0/24'
    '20.49.104.0/21'
    '20.51.128.0/17'
    '20.55.0.0/17'
    '20.60.0.0/24'
    '20.60.2.0/23'
    '20.60.6.0/23'
    '20.60.60.0/22'
    '20.60.128.0/23'
    '20.60.134.0/23'
    '20.60.146.0/23'
    '20.62.128.0/17'
    '20.72.128.0/18'
    '20.75.128.0/17'
    '20.81.0.0/17'
    '20.83.128.0/18'
    '20.84.0.0/17'
    '20.85.128.0/17'
    '20.135.4.0/22'
    '20.135.194.0/23'
    '20.135.196.0/22'
    '20.150.32.0/23'
    '20.150.90.0/24'
    '20.157.39.0/24'
    '20.185.0.0/16'
    '20.190.130.0/24'
    '20.190.151.0/24'
    '23.96.0.0/17'
    '23.98.45.0/24'
    '23.100.16.0/20'
    '23.101.128.0/20'
    '40.71.0.0/16'
    '40.76.0.0/16'
    '40.78.219.0/24'
    '40.78.224.0/21'
    '40.79.152.0/21'
    '40.80.144.0/21'
    '40.82.24.0/22'
    '40.82.60.0/22'
    '40.85.160.0/19'
    '40.87.0.0/17'
    '40.87.164.0/22'
    '40.88.0.0/16'
    '40.90.23.128/25'
    '40.90.24.128/25'
    '40.90.25.0/26'
    '40.90.30.192/26'
    '40.90.129.128/26'
    '40.90.130.96/28'
    '40.90.131.224/27'
    '40.90.136.16/28'
    '40.90.136.32/27'
    '40.90.137.96/27'
    '40.90.139.224/27'
    '40.90.143.0/27'
    '40.90.146.64/26'
    '40.90.147.0/27'
    '40.90.148.64/27'
    '40.90.150.32/27'
    '40.90.224.0/19'
    '40.91.4.0/22'
    '40.93.2.0/24'
    '40.93.4.0/24'
    '40.112.48.0/20'
    '40.114.0.0/17'
    '40.117.32.0/19'
    '40.117.64.0/18'
    '40.117.128.0/17'
    '40.121.0.0/16'
    '40.123.132.0/22'
    '40.126.2.0/24'
    '40.126.23.0/24'
    '52.101.4.0/22'
    '52.101.9.0/24'
    '52.101.20.0/22'
    '52.102.129.0/24'
    '52.102.159.0/24'
    '52.103.1.0/24'
    '52.103.3.0/24'
    '52.103.129.0/24'
    '52.108.16.0/21'
    '52.108.79.0/24'
    '52.108.105.0/24'
    '52.108.106.0/23'
    '52.109.12.0/22'
    '52.111.229.0/24'
    '52.112.112.0/24'
    '52.113.16.0/20'
    '52.114.132.0/22'
    '52.115.54.0/24'
    '52.115.62.0/23'
    '52.115.192.0/19'
    '52.120.32.0/19'
    '52.120.224.0/20'
    '52.125.132.0/22'
    '52.136.64.0/18'
    '52.142.0.0/18'
    '52.143.207.0/24'
    '52.146.0.0/17'
    '52.147.192.0/18'
    '52.149.128.0/17'
    '52.150.0.0/17'
    '52.151.128.0/17'
    '52.152.128.0/17'
    '52.154.64.0/18'
    '52.168.0.0/16'
    '52.170.0.0/16'
    '52.179.0.0/17'
    '52.186.0.0/16'
    '52.188.0.0/16'
    '52.190.0.0/17'
    '52.191.0.0/17'
    '52.191.192.0/18'
    '52.224.0.0/16'
    '52.226.0.0/16'
    '52.232.146.0/24'
    '52.234.128.0/17'
    '52.239.152.0/22'
    '52.239.168.0/22'
    '52.239.207.192/26'
    '52.239.214.0/23'
    '52.239.220.0/23'
    '52.239.246.0/23'
    '52.239.252.0/24'
    '52.240.0.0/17'
    '52.245.8.0/22'
    '52.245.104.0/22'
    '52.249.128.0/17'
    '52.253.160.0/24'
    '52.255.128.0/17'
    '65.54.19.128/27'
    '104.41.128.0/19'
    '104.44.91.32/27'
    '104.44.94.16/28'
    '104.44.95.160/27'
    '104.44.95.240/28'
    '104.45.128.0/18'
    '104.45.192.0/20'
    '104.211.0.0/18'
    '137.116.112.0/20'
    '137.117.32.0/19'
    '137.117.64.0/18'
    '137.135.64.0/18'
    '138.91.96.0/19'
    '157.56.176.0/21'
    '168.61.32.0/20'
    '168.61.48.0/21'
    '168.62.32.0/19'
    '168.62.160.0/19'
    '191.234.32.0/19'
    '191.236.0.0/18'
    '191.237.0.0/17'
    '191.238.0.0/18'
    '2603:1030:20c::/47'
    '2603:1030:20e::/48'
    '2603:1030:210::/47'
    '2603:1036:120d::/48'
    '2603:1036:2404::/48'
    '2603:1036:3000:120::/59'
    '2603:1037:1:120::/59'
    '2a01:111:f100:2000::/52'
    '2a01:111:f403:c100::/64'
    '2a01:111:f403:c900::/64'
    '2a01:111:f403:d100::/64'
    '2a01:111:f403:d900::/64'
    '2a01:111:f403:f000::/64'
    '2a01:111:f403:f900::/62'
  ]
}

var dtlRpIpMatchCondition_canadacentral = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // AzureCloud.canadacentral
  matchValues: [
    '13.71.160.0/19'
    '13.88.224.0/19'
    '13.104.151.192/26'
    '13.104.152.0/25'
    '13.104.208.176/28'
    '13.104.212.192/26'
    '13.104.223.192/26'
    '20.38.114.0/25'
    '20.38.144.0/21'
    '20.39.128.0/20'
    '20.43.0.0/19'
    '20.47.40.0/24'
    '20.47.87.0/24'
    '20.48.128.0/18'
    '20.48.192.0/21'
    '20.48.224.0/19'
    '20.60.42.0/23'
    '20.63.0.0/17'
    '20.135.182.0/23'
    '20.135.184.0/22'
    '20.150.16.0/24'
    '20.150.31.0/24'
    '20.150.71.0/24'
    '20.150.100.0/24'
    '20.151.0.0/17'
    '20.151.128.0/18'
    '20.157.52.0/24'
    '20.190.139.0/25'
    '20.190.161.0/24'
    '20.200.64.0/18'
    '40.79.216.0/24'
    '40.80.44.0/22'
    '40.82.160.0/19'
    '40.85.192.0/18'
    '40.90.17.144/28'
    '40.90.128.0/28'
    '40.90.138.32/27'
    '40.90.143.160/27'
    '40.90.151.96/27'
    '40.126.11.0/25'
    '40.126.33.0/24'
    '52.108.42.0/23'
    '52.108.84.0/24'
    '52.109.92.0/22'
    '52.111.251.0/24'
    '52.114.160.0/22'
    '52.136.23.0/24'
    '52.136.27.0/24'
    '52.138.0.0/18'
    '52.139.0.0/18'
    '52.156.0.0/19'
    '52.228.0.0/17'
    '52.233.0.0/18'
    '52.237.0.0/18'
    '52.239.148.64/26'
    '52.239.189.0/24'
    '52.245.28.0/22'
    '52.246.152.0/21'
    '52.253.196.0/24'
    '104.44.93.32/27'
    '104.44.95.16/28'
    '2603:1030:208::/47'
    '2603:1030:f00::/47'
    '2603:1030:f02::/48'
    '2603:1030:f04::/48'
    '2603:1030:f05::/48'
    '2603:1030:f06::/48'
    '2603:1030:f07::/56'
    '2603:1036:2401::/48'
    '2603:1036:2500:30::/64'
    '2603:1036:3000:40::/59'
    '2603:1037:1:40::/59'
  ]
}

var dtlRpIpMatchCondition_japaneast = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // AzureCloud.japaneast
  matchValues: [
    '13.71.128.0/19'
    '13.73.0.0/19'
    '13.78.0.0/17'
    '13.104.149.64/26'
    '13.104.150.128/26'
    '13.104.221.0/24'
    '13.105.18.64/26'
    '20.37.96.0/19'
    '20.38.116.0/23'
    '20.40.88.0/21'
    '20.40.96.0/21'
    '20.43.64.0/19'
    '20.44.128.0/18'
    '20.46.112.0/20'
    '20.46.160.0/19'
    '20.47.12.0/24'
    '20.47.101.0/24'
    '20.48.0.0/17'
    '20.60.172.0/23'
    '20.63.128.0/18'
    '20.78.0.0/17'
    '20.78.192.0/18'
    '20.89.0.0/17'
    '20.135.102.0/23'
    '20.135.104.0/22'
    '20.150.85.0/24'
    '20.150.105.0/24'
    '20.157.38.0/24'
    '20.188.0.0/19'
    '20.190.141.128/25'
    '20.190.166.0/24'
    '20.191.160.0/19'
    '20.194.128.0/17'
    '23.98.57.64/26'
    '23.100.96.0/21'
    '23.102.64.0/19'
    '40.79.184.0/21'
    '40.79.192.0/21'
    '40.79.206.96/27'
    '40.79.208.0/24'
    '40.81.192.0/19'
    '40.82.48.0/22'
    '40.87.200.0/22'
    '40.90.16.160/27'
    '40.90.128.80/28'
    '40.90.132.64/28'
    '40.90.142.0/27'
    '40.90.142.192/28'
    '40.90.148.224/27'
    '40.90.152.192/27'
    '40.90.158.0/26'
    '40.115.128.0/17'
    '40.126.13.128/25'
    '40.126.38.0/24'
    '52.108.191.0/24'
    '52.108.228.0/23'
    '52.109.52.0/22'
    '52.111.232.0/24'
    '52.112.176.0/21'
    '52.112.184.0/22'
    '52.113.78.0/23'
    '52.113.102.0/24'
    '52.113.107.0/24'
    '52.113.133.0/24'
    '52.114.32.0/22'
    '52.115.38.0/24'
    '52.115.47.0/24'
    '52.121.120.0/23'
    '52.121.152.0/21'
    '52.121.160.0/22'
    '52.121.164.0/24'
    '52.136.31.0/24'
    '52.140.192.0/18'
    '52.155.96.0/19'
    '52.156.32.0/19'
    '52.185.128.0/18'
    '52.232.155.0/24'
    '52.239.144.0/23'
    '52.243.32.0/19'
    '52.245.36.0/22'
    '52.246.160.0/19'
    '52.253.96.0/19'
    '52.253.161.0/24'
    '104.41.160.0/19'
    '104.44.88.224/27'
    '104.44.91.224/27'
    '104.44.94.112/28'
    '104.46.208.0/20'
    '138.91.0.0/20'
    '191.237.240.0/23'
    '2603:1040:400::/46'
    '2603:1040:404::/48'
    '2603:1040:406::/48'
    '2603:1040:407::/48'
    '2603:1046:1402::/48'
    '2603:1046:1500:18::/64'
    '2603:1046:2000:140::/59'
    '2603:1047:1:140::/59'
  ]
}

var dtlRpIpMatchCondition_eastasia = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // AzureCloud.eastasia
  matchValues: [
    '13.70.0.0/18'
    '13.72.192.0/19'
    '13.75.0.0/17'
    '13.88.208.0/20'
    '13.94.0.0/18'
    '13.104.155.64/26'
    '13.104.155.192/26'
    '13.105.14.192/26'
    '13.105.16.0/25'
    '20.47.43.0/24'
    '20.47.126.0/23'
    '20.60.131.0/24'
    '20.135.40.0/23'
    '20.150.1.128/25'
    '20.150.22.0/24'
    '20.150.96.0/24'
    '20.157.53.0/24'
    '20.187.64.0/18'
    '20.187.128.0/18'
    '20.187.192.0/21'
    '20.187.224.0/19'
    '20.189.64.0/18'
    '20.190.140.128/25'
    '20.190.164.0/24'
    '20.195.72.0/21'
    '23.97.64.0/19'
    '23.98.32.0/21'
    '23.98.40.0/22'
    '23.98.44.0/24'
    '23.99.96.0/19'
    '23.100.88.0/21'
    '23.101.0.0/20'
    '23.102.200.0/23'
    '23.102.224.0/19'
    '40.77.134.0/24'
    '40.77.136.16/28'
    '40.77.160.32/27'
    '40.77.160.64/26'
    '40.77.160.128/25'
    '40.77.161.0/26'
    '40.77.161.128/25'
    '40.77.175.128/27'
    '40.77.192.0/22'
    '40.77.201.0/24'
    '40.77.226.0/25'
    '40.77.234.128/27'
    '40.77.236.192/28'
    '40.77.237.128/25'
    '40.77.252.0/23'
    '40.79.210.0/24'
    '40.81.16.0/20'
    '40.82.116.0/22'
    '40.83.64.0/18'
    '40.87.192.0/22'
    '40.90.154.192/26'
    '40.126.12.128/25'
    '40.126.36.0/24'
    '52.108.32.0/22'
    '52.108.81.0/24'
    '52.109.120.0/22'
    '52.111.228.0/24'
    '52.113.96.0/22'
    '52.113.100.0/24'
    '52.113.104.0/24'
    '52.113.108.0/24'
    '52.114.0.0/21'
    '52.114.52.0/23'
    '52.115.40.0/22'
    '52.115.44.0/23'
    '52.115.46.0/24'
    '52.115.96.0/24'
    '52.120.157.0/24'
    '52.121.112.0/22'
    '52.139.128.0/18'
    '52.175.0.0/17'
    '52.184.0.0/17'
    '52.229.128.0/17'
    '52.232.153.0/24'
    '52.239.128.0/24'
    '52.239.224.0/24'
    '52.245.56.0/22'
    '52.246.128.0/20'
    '65.52.160.0/19'
    '104.44.88.192/27'
    '104.44.90.224/27'
    '104.44.91.192/27'
    '104.44.94.96/28'
    '104.46.24.0/22'
    '104.208.64.0/18'
    '104.214.160.0/19'
    '111.221.29.0/24'
    '111.221.30.0/23'
    '111.221.78.0/23'
    '131.253.13.100/30'
    '131.253.13.104/30'
    '131.253.35.192/26'
    '134.170.192.0/21'
    '137.116.160.0/20'
    '168.63.128.0/24'
    '168.63.129.0/28'
    '168.63.129.32/27'
    '168.63.129.64/26'
    '168.63.129.128/25'
    '168.63.130.0/23'
    '168.63.132.0/22'
    '168.63.136.0/21'
    '168.63.148.0/22'
    '168.63.152.0/22'
    '168.63.156.0/24'
    '168.63.192.0/19'
    '191.232.140.0/24'
    '191.234.2.0/23'
    '191.234.16.0/20'
    '191.237.238.0/24'
    '204.231.197.0/24'
    '207.46.67.160/27'
    '207.46.67.192/27'
    '207.46.72.0/27'
    '207.46.77.224/28'
    '207.46.87.0/24'
    '207.46.89.16/28'
    '207.46.95.32/27'
    '207.46.126.0/24'
    '207.46.128.0/19'
    '207.68.174.208/28'
    '2603:1040:200::/46'
    '2603:1040:204::/48'
    '2603:1040:206::/48'
    '2603:1040:207::/48'
    '2603:1046:1401::/48'
    '2603:1046:1500:24::/64'
    '2603:1046:2000:40::/59'
    '2603:1047:1:40::/59'
    '2a01:111:f100:6000::/64'
  ]
}

var dtlRpIpMatchCondition_northeurope = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // AzureCloud.northeurope
  matchValues: [
    '13.69.128.0/17'
    '13.70.192.0/18'
    '13.74.0.0/16'
    '13.79.0.0/16'
    '13.94.64.0/18'
    '13.104.148.0/25'
    '13.104.149.128/25'
    '13.104.150.0/25'
    '13.104.208.160/28'
    '13.104.210.0/24'
    '13.105.18.0/26'
    '13.105.21.0/24'
    '13.105.28.48/28'
    '13.105.37.192/26'
    '13.105.60.192/26'
    '13.105.67.0/25'
    '13.105.96.128/25'
    '20.38.64.0/19'
    '20.38.102.0/23'
    '20.47.8.0/24'
    '20.47.20.0/23'
    '20.47.32.0/24'
    '20.47.111.0/24'
    '20.47.117.0/24'
    '20.50.64.0/20'
    '20.50.80.0/21'
    '20.54.0.0/17'
    '20.60.19.0/24'
    '20.60.40.0/23'
    '20.60.144.0/23'
    '20.67.128.0/17'
    '20.82.128.0/17'
    '20.135.20.0/22'
    '20.135.134.0/23'
    '20.135.136.0/22'
    '20.150.26.0/24'
    '20.150.47.128/25'
    '20.150.48.0/24'
    '20.150.75.0/24'
    '20.150.84.0/24'
    '20.150.104.0/24'
    '20.190.129.0/24'
    '20.190.159.0/24'
    '20.191.0.0/18'
    '23.100.48.0/20'
    '23.100.128.0/18'
    '23.101.48.0/20'
    '23.102.0.0/18'
    '40.67.224.0/19'
    '40.69.0.0/18'
    '40.69.64.0/19'
    '40.69.192.0/19'
    '40.77.133.0/24'
    '40.77.136.32/28'
    '40.77.136.80/28'
    '40.77.165.0/24'
    '40.77.174.0/24'
    '40.77.175.160/27'
    '40.77.182.96/27'
    '40.77.226.128/25'
    '40.77.229.0/24'
    '40.77.234.160/27'
    '40.77.236.0/27'
    '40.77.236.176/28'
    '40.77.255.0/25'
    '40.78.211.0/24'
    '40.79.204.0/27'
    '40.79.204.32/28'
    '40.79.204.64/27'
    '40.85.0.0/17'
    '40.85.128.0/20'
    '40.87.128.0/19'
    '40.87.188.0/22'
    '40.90.17.192/27'
    '40.90.25.64/26'
    '40.90.25.128/26'
    '40.90.31.128/25'
    '40.90.128.16/28'
    '40.90.129.192/27'
    '40.90.130.224/28'
    '40.90.133.64/27'
    '40.90.136.176/28'
    '40.90.137.192/27'
    '40.90.140.64/27'
    '40.90.141.96/27'
    '40.90.141.128/27'
    '40.90.145.0/27'
    '40.90.145.224/27'
    '40.90.147.96/27'
    '40.90.148.160/28'
    '40.90.149.128/25'
    '40.90.153.128/25'
    '40.91.20.0/22'
    '40.91.32.0/22'
    '40.112.36.0/25'
    '40.112.37.64/26'
    '40.112.64.0/19'
    '40.113.0.0/18'
    '40.113.64.0/19'
    '40.115.96.0/19'
    '40.126.1.0/24'
    '40.126.31.0/24'
    '40.127.96.0/20'
    '40.127.128.0/17'
    '51.104.64.0/18'
    '51.104.128.0/18'
    '52.108.174.0/23'
    '52.108.176.0/24'
    '52.108.196.0/24'
    '52.108.240.0/21'
    '52.109.76.0/22'
    '52.111.236.0/24'
    '52.112.191.0/24'
    '52.112.229.0/24'
    '52.112.232.0/24'
    '52.112.236.0/24'
    '52.113.40.0/21'
    '52.113.48.0/20'
    '52.113.112.0/20'
    '52.113.136.0/21'
    '52.113.205.0/24'
    '52.114.76.0/22'
    '52.114.96.0/21'
    '52.114.120.0/22'
    '52.114.231.0/24'
    '52.114.233.0/24'
    '52.114.248.0/22'
    '52.115.16.0/21'
    '52.115.24.0/22'
    '52.120.136.0/21'
    '52.120.192.0/20'
    '52.121.16.0/21'
    '52.121.48.0/20'
    '52.125.138.0/23'
    '52.138.128.0/17'
    '52.142.64.0/18'
    '52.143.195.0/24'
    '52.143.209.0/24'
    '52.146.128.0/17'
    '52.155.64.0/19'
    '52.155.128.0/17'
    '52.156.192.0/18'
    '52.158.0.0/17'
    '52.164.0.0/16'
    '52.169.0.0/16'
    '52.178.128.0/17'
    '52.232.148.0/24'
    '52.236.0.0/17'
    '52.239.136.0/22'
    '52.239.205.0/24'
    '52.239.248.0/24'
    '52.245.40.0/22'
    '52.245.88.0/22'
    '65.52.64.0/20'
    '65.52.224.0/21'
    '94.245.88.0/21'
    '94.245.104.0/21'
    '94.245.114.1/32'
    '94.245.114.2/31'
    '94.245.114.4/32'
    '94.245.114.33/32'
    '94.245.114.34/31'
    '94.245.114.36/32'
    '94.245.117.96/27'
    '94.245.118.0/27'
    '94.245.118.65/32'
    '94.245.118.66/31'
    '94.245.118.68/32'
    '94.245.118.97/32'
    '94.245.118.98/31'
    '94.245.118.100/32'
    '94.245.118.129/32'
    '94.245.118.130/31'
    '94.245.118.132/32'
    '94.245.120.128/28'
    '94.245.122.0/24'
    '94.245.123.144/28'
    '94.245.123.176/28'
    '104.41.64.0/18'
    '104.41.192.0/18'
    '104.44.88.64/27'
    '104.44.91.64/27'
    '104.44.92.192/27'
    '104.44.94.32/28'
    '104.45.80.0/20'
    '104.45.96.0/19'
    '104.46.8.0/21'
    '104.46.64.0/19'
    '104.47.218.0/23'
    '131.253.40.80/28'
    '134.170.80.64/28'
    '137.116.224.0/19'
    '137.135.128.0/17'
    '138.91.48.0/20'
    '157.55.3.0/24'
    '157.55.10.160/29'
    '157.55.10.176/28'
    '157.55.13.128/26'
    '157.55.107.0/24'
    '157.55.204.128/25'
    '168.61.80.0/20'
    '168.61.96.0/19'
    '168.63.32.0/19'
    '168.63.64.0/20'
    '168.63.80.0/21'
    '168.63.92.0/22'
    '191.232.138.0/23'
    '191.235.128.0/18'
    '191.235.192.0/22'
    '191.235.208.0/20'
    '191.235.255.0/24'
    '191.237.192.0/23'
    '191.237.194.0/24'
    '191.237.196.0/24'
    '191.237.208.0/20'
    '191.238.96.0/19'
    '191.239.208.0/20'
    '193.149.88.0/21'
    '2603:1020::/47'
    '2603:1020:2::/48'
    '2603:1020:4::/48'
    '2603:1020:5::/48'
    '2603:1026:2404::/48'
    '2603:1026:3000:c0::/59'
    '2603:1027:1:c0::/59'
    '2a01:111:f100:a000::/63'
    '2a01:111:f100:a002::/64'
    '2a01:111:f100:a004::/64'
  ]
}

var dtlRpIpMatchCondition_australiaeast = {
  operator: 'IPMatch'
  negationConditon: true
  matchVariables: [
    {
      variableName: 'RemoteAddr'
    }
  ]
  // AzureCloud.australiaeast
  matchValues: [
    '13.70.64.0/18'
    '13.72.224.0/19'
    '13.73.192.0/20'
    '13.75.128.0/17'
    '13.104.211.128/26'
    '13.105.16.192/26'
    '13.105.20.128/26'
    '13.105.52.192/26'
    '13.105.53.128/26'
    '20.37.192.0/19'
    '20.38.112.0/23'
    '20.40.64.0/20'
    '20.40.80.0/21'
    '20.40.120.0/21'
    '20.40.176.0/20'
    '20.42.192.0/19'
    '20.43.96.0/20'
    '20.47.37.0/24'
    '20.47.122.0/23'
    '20.53.32.0/28'
    '20.53.40.0/21'
    '20.53.64.0/18'
    '20.53.128.0/17'
    '20.58.128.0/18'
    '20.60.72.0/22'
    '20.60.182.0/23'
    '20.70.128.0/17'
    '20.135.120.0/21'
    '20.150.66.0/24'
    '20.150.92.0/24'
    '20.150.117.0/24'
    '20.157.44.0/24'
    '20.188.128.0/17'
    '20.190.142.0/25'
    '20.190.167.0/24'
    '20.191.192.0/18'
    '20.193.0.0/18'
    '20.193.64.0/19'
    '23.101.208.0/20'
    '40.79.160.0/20'
    '40.79.211.0/24'
    '40.82.32.0/22'
    '40.82.192.0/19'
    '40.87.208.0/22'
    '40.90.18.0/28'
    '40.90.30.0/25'
    '40.90.130.80/28'
    '40.90.130.208/28'
    '40.90.140.32/27'
    '40.90.142.160/27'
    '40.90.147.64/27'
    '40.90.150.0/27'
    '40.112.37.128/26'
    '40.126.14.0/25'
    '40.126.39.0/24'
    '40.126.224.0/19'
    '52.108.40.0/23'
    '52.108.83.0/24'
    '52.109.112.0/22'
    '52.111.224.0/24'
    '52.113.88.0/22'
    '52.113.103.0/24'
    '52.114.16.0/22'
    '52.114.58.0/23'
    '52.114.192.0/23'
    '52.115.98.0/24'
    '52.120.158.0/23'
    '52.121.108.0/22'
    '52.143.199.0/24'
    '52.143.200.0/23'
    '52.147.0.0/19'
    '52.156.160.0/19'
    '52.187.192.0/18'
    '52.232.136.0/21'
    '52.232.154.0/24'
    '52.237.192.0/18'
    '52.239.130.0/23'
    '52.239.226.0/24'
    '52.245.16.0/22'
    '104.44.90.64/26'
    '104.44.93.96/27'
    '104.44.95.48/28'
    '104.46.29.0/24'
    '104.46.30.0/23'
    '104.209.80.0/20'
    '104.210.64.0/18'
    '191.238.66.0/23'
    '191.239.64.0/19'
    '2603:1010::/46'
    '2603:1010:5::/48'
    '2603:1010:6::/48'
    '2603:1016:1400:60::/59'
    '2603:1016:2402::/48'
    '2603:1016:2500:c::/64'
    '2603:1017:0:60::/59'
  ]
}

var dtlRpIpMatchConditions_centralus = [
  dtlRpIpMatchCondition_centralus
  dtlRpIpMatchCondition_eastus
]

var dtlRpIpMatchConditions_eastus = [
  dtlRpIpMatchCondition_eastus
  dtlRpIpMatchCondition_canadacentral
  dtlRpIpMatchCondition_japaneast
  dtlRpIpMatchCondition_eastasia
  dtlRpIpMatchCondition_northeurope
  dtlRpIpMatchCondition_australiaeast
]

var dtlRpIpMatchConditions = resourceGroup().location =~ 'centralus' || resourceGroup().location =~ 'central us' ? dtlRpIpMatchConditions_centralus : resourceGroup().location =~ 'eastus' || resourceGroup().location =~ 'east us' ? dtlRpIpMatchConditions_eastus : []

resource pip_existing 'Microsoft.Network/publicIPAddresses@2020-06-01' existing = if (!empty(publicIPAddress)) {
  name: publicIPAddressName
}

resource pip_new 'Microsoft.Network/publicIPAddresses@2020-06-01' = if (empty(publicIPAddress)) {
  name: publicIPAddressName
  location: resourceGroup().location
  sku: {
    name: 'Standard'
  }
  properties: {
    publicIPAllocationMethod: 'Static'
    publicIPAddressVersion: 'IPv4'
    idleTimeoutInMinutes: 4
    dnsSettings: {
      domainNameLabel: resourcePrefix
    }
  }
  tags: tags
}

resource identity 'Microsoft.ManagedIdentity/userAssignedIdentities@2018-11-30' = {
  name: appGatewayName
  location: resourceGroup().location
  tags: tags
}

module accessPolicy 'gatewayPolicy.bicep' = {
  name: 'gatewayIdentityAccessPolicy'
  params: {
    keyVaultName: keyVaultName
    tenantId: identity.properties.tenantId
    principalId: identity.properties.principalId
  }
}

resource wafPolicy 'Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies@2020-08-01' = {
  name: appGatewayFirewallPolicyName
  location: resourceGroup().location
  properties: {
    policySettings: {
      mode: 'Prevention'
      state: 'Enabled'
    }
    customRules: [
      {
        name: 'AllowAzureCloud'
        priority: 10
        ruleType: 'MatchRule'
        action: 'Block'
        matchConditions: dtlRpIpMatchConditions
      }
    ]
    managedRules: {
      managedRuleSets: [
        {
          ruleSetType: 'OWASP'
          ruleSetVersion: '3.1'
          ruleGroupOverrides: [
            {
              ruleGroupName: 'REQUEST-920-PROTOCOL-ENFORCEMENT'
              rules: [
                {
                  ruleId: '920100' // Invalid HTTP Request Line rule
                  state: 'Disabled' // Disabled to allow RDG_OUT_DATA and RPC_IN_DATA
                }
                {
                  ruleId: '920440' // URL file extension is restricted by policy
                  state: 'Disabled' // Disabled to allow connection to /rpc/rpcproxy.dll
                }
              ]
            }
            {
              ruleGroupName: 'REQUEST-911-METHOD-ENFORCEMENT'
              rules: [
                {
                  ruleId: '911100' // Method is not allowed by policy
                  state: 'Disabled' // Disabled to allow RDG_OUT_DATA and RPC_IN_DATA
                }
              ]
            }
          ]
        }
      ]
    }
  }
  tags: tags
}

resource gw 'Microsoft.Network/applicationGateways@2020-06-01' = {
  name: appGatewayName
  location: resourceGroup().location
  dependsOn: [
    accessPolicy
  ]
  identity: {
    type: 'UserAssigned'
    userAssignedIdentities: {
      '${identity.id}': {}
    }
  }
  properties: {
    sku: {
      name: 'WAF_v2'
      tier: 'WAF_v2'
      capacity: 2
    }
    gatewayIPConfigurations: [
      {
        name: 'gatewayIpConfig'
        properties: {
          subnet: {
            id: subnet
          }
        }
      }
    ]
    frontendIPConfigurations: [
      {
        name: gateway.frontendIp.public.name
        properties: {
          privateIPAllocationMethod: 'Dynamic'
          publicIPAddress: {
            id: empty(publicIPAddress) ? pip_new.id : pip_existing.id
          }
        }
      }
      {
        name: gateway.frontendIp.private.name
        properties: {
          privateIPAddress: privateIPAddress
          privateIPAllocationMethod: 'Static'
          subnet: {
            id: subnet
          }
        }
      }
    ]
    frontendPorts: [
      {
        name: 'Port443'
        properties: {
          port: 443
        }
      }
      {
        name: 'Port80'
        properties: {
          port: 80
        }
      }
    ]
    backendAddressPools: [
      {
        name: 'gatewayBackend'
        properties: {
          backendAddresses: []
        }
      }
      {
        name: 'apiBackend'
        properties: {
          backendAddresses: [
            {
              fqdn: apiHost
            }
          ]
        }
      }
    ]
    backendHttpSettingsCollection: [
      {
        name: gateway.backendHttpSettings.name
        properties: {
          port: 443
          protocol: 'Https'
          cookieBasedAffinity: 'Disabled'
          hostName: gatewayHost
          requestTimeout: 20
          pickHostNameFromBackendAddress: false
          probe: gateway.healthCheckProbe.ref
        }
      }
      {
        name: api.backendHttpSettings.name
        properties: {
          port: 443
          protocol: 'Https'
          cookieBasedAffinity: 'Disabled'
          requestTimeout: 20
          pickHostNameFromBackendAddress: true
          probe: api.healthCheckProbe.ref
        }
      }
    ]
    httpListeners: [
      {
        name: gateway.httpListener.public.name
        properties: {
          protocol: 'Https'
          frontendIPConfiguration: gateway.frontendIp.public.ref
          frontendPort: {
            id: resourceId('Microsoft.Network/applicationGateways/frontendPorts/', appGatewayName, 'Port443')
          }
          sslCertificate: {
            id: resourceId('Microsoft.Network/applicationGateways/sslCertificates/', appGatewayName, gatewayHost)
          }
        }
      }
      {
        name: gateway.httpListener.private.name
        properties: {
          protocol: 'Http'
          frontendIPConfiguration: gateway.frontendIp.private.ref
          frontendPort: {
            id: resourceId('Microsoft.Network/applicationGateways/frontendPorts/', appGatewayName, 'Port80')
          }
          sslCertificate: null
        }
      }
    ]
    requestRoutingRules: [
      {
        name: gateway.routingRule.public.name
        properties: {
          ruleType: 'PathBasedRouting'
          httpListener: gateway.httpListener.public.ref
          urlPathMap: gateway.routingRule.public.urlPathMapRef
        }
      }
      {
        name: gateway.routingRule.private.name
        properties: {
          ruleType: 'PathBasedRouting'
          httpListener: gateway.httpListener.private.ref
          urlPathMap: gateway.routingRule.private.urlPathMapRef
        }
      }
    ]
    enableHttp2: false
    sslCertificates: [
      {
        name: gatewayHost
        properties: {
          keyVaultSecretId: sslCertificateSecretUri
        }
      }
    ]
    probes: [
      {
        name: gateway.healthCheckProbe.name
        properties: {
          backendHttpSettings: [
            gateway.backendHttpSettings.ref
          ]
          protocol: 'Https'
          path: '/api/health'
          interval: 300
          timeout: 30
          unhealthyThreshold: 3
          pickHostNameFromBackendHttpSettings: true
          minServers: 0
        }
      }
      {
        name: api.healthCheckProbe.name
        properties: {
          backendHttpSettings: [
            api.backendHttpSettings.ref
          ]
          protocol: 'Https'
          path: '/api/health'
          interval: 300
          timeout: 30
          unhealthyThreshold: 3
          pickHostNameFromBackendHttpSettings: true
          minServers: 0
        }
      }
    ]
    urlPathMaps: [
      {
        name: gateway.routingRule.public.name
        properties: {
          pathRules: [
            {
              name: 'apiTarget'
              properties: {
                paths: [
                  '/api/*'
                ]
                backendAddressPool: api.backendAddressPool.ref
                backendHttpSettings: api.backendHttpSettings.ref
              }
            }
          ]
          defaultBackendAddressPool: gateway.backendAddressPool.ref
          defaultBackendHttpSettings: gateway.backendHttpSettings.ref
        }
      }
      {
        name: gateway.routingRule.private.name
        properties: {
          pathRules: [
            {
              name: 'apiTarget'
              properties: {
                paths: [
                  '/api/*'
                ]
                backendAddressPool: api.backendAddressPool.ref
                backendHttpSettings: api.backendHttpSettings.ref
              }
            }
          ]
          defaultBackendAddressPool: gateway.backendAddressPool.ref
          defaultBackendHttpSettings: gateway.backendHttpSettings.ref
        }
      }
    ]
    firewallPolicy: {
      id: wafPolicy.id
    }
  }
  tags: tags
}

resource diagnostics 'microsoft.insights/diagnosticSettings@2017-05-01-preview' = if (!empty(logAnalyticsWrokspaceId)) {
  name: 'diagnostics'
  scope: gw
  properties: {
    workspaceId: logAnalyticsWrokspaceId
    logs: [
      {
        category: 'ApplicationGatewayAccessLog'
        enabled: true
      }
      {
        category: 'ApplicationGatewayPerformanceLog'
        enabled: true
      }
      {
        category: 'ApplicationGatewayFirewallLog'
        enabled: true
      }
    ]
  }
}

// output ip string = createPublicIpAddress ? publicIPAddress_new.properties.ipAddress : !empty(publicIPAddress) ? publicIPAddress_existing.properties.ipAddress : privateIPAddress
output ip string = empty(publicIPAddress) ? pip_new.properties.ipAddress : pip_existing.properties.ipAddress
output backendAddressPools array = [
  {
    id: resourceId('Microsoft.Network/applicationGateways/backendAddressPools/', appGatewayName, 'gatewayBackend')
  }
]
